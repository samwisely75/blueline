name: Cucumber Integration Tests

on:
  push:
    branches: 
      # Only run on the feature branch for now
      - feature/clean-io-abstraction
  pull_request:
    branches: 
      - develop
      - main
    paths:
      # Run when test files or source files change
      - 'tests/**'
      - 'features/**'
      - 'src/**'
      - 'Cargo.toml'
      - 'Cargo.lock'
      - '.github/workflows/cucumber-tests.yml'

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  # Set default log level for tests
  RUST_LOG: info,blueline=debug,integration_tests=debug

jobs:
  cucumber-tests:
    name: Run Cucumber Integration Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Rust toolchain
      uses: dtolnay/rust-toolchain@stable
      with:
        components: rustfmt, clippy

    - name: Cache Rust dependencies and build artifacts
      uses: Swatinem/rust-cache@v2
      with:
        # Cache key based on the job name and Cargo.lock
        key: cucumber-tests-${{ hashFiles('**/Cargo.lock') }}
        # Share cache across different os/job if they have the same target
        shared-key: "shared"
        # Cache the target directory (compiled artifacts)
        cache-targets: true
        # Cache the Cargo registry and git dependencies
        cache-all-crates: true
        # Save space by cleaning up old cache entries
        save-if: ${{ github.ref == 'refs/heads/develop' || github.ref == 'refs/heads/main' }}
        # Include test artifacts in cache
        cache-directories: |
          ~/.cargo/bin/
          target/debug/deps/
          target/debug/build/

    - name: Build test dependencies
      run: |
        echo "Building library and test dependencies with caching..."
        # Build in release mode for better performance, but use debug for tests to get better error info
        cargo build --lib
        # Pre-compile test dependencies to cache them
        cargo test --test integration_tests --no-run
        echo "✅ Build artifacts cached successfully"
        
    - name: Show cache statistics
      run: |
        echo "=== Cache Statistics ==="
        echo "Target directory size:"
        du -sh target/ 2>/dev/null || echo "No target directory"
        echo "Cargo cache size:"
        du -sh ~/.cargo/ 2>/dev/null || echo "No cargo cache"
        echo "Number of cached test binaries:"
        find target/debug/deps/ -name "*integration_tests*" -type f 2>/dev/null | wc -l || echo "0"

    - name: Check feature files exist
      run: |
        echo "Checking for feature files..."
        if [ -d "features" ]; then
          echo "Found feature files:"
          find features -name "*.feature" -type f | head -20
        else
          echo "No features directory found, tests will look for feature files"
        fi

    - name: Run Cucumber integration tests
      run: |
        echo "Running Cucumber integration tests with cached artifacts..."
        # Check if test binary exists (should be cached from previous step)
        if [ -f "target/debug/deps/integration_tests-"* ]; then
          echo "✅ Found cached test binary"
        else
          echo "⚠️  No cached test binary found, will compile on-demand"
        fi
        # Run with timeout to prevent hanging tests
        timeout 300s cargo test --test integration_tests --verbose -- --nocapture
      continue-on-error: true
      id: cucumber-test

    - name: Run Cucumber tests with trace logging (on failure)
      if: steps.cucumber-test.outcome == 'failure'
      run: |
        echo "First run failed, retrying with trace logging..."
        RUST_LOG=trace timeout 300s cargo test --test integration_tests -- --nocapture --test-threads=1
      continue-on-error: true

    - name: Check test results
      run: |
        if [ "${{ steps.cucumber-test.outcome }}" == "failure" ]; then
          echo "::warning::Cucumber tests failed. This is expected during initial implementation."
          echo "Review the logs above for details."
          # Don't fail the workflow during initial implementation
          # Change this to 'exit 1' once tests are stable
          exit 0
        else
          echo "✅ Cucumber tests passed successfully!"
        fi

    - name: Upload test logs (if any)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: cucumber-test-logs
        path: |
          **/*.log
          **/test_output.txt
        retention-days: 7
        if-no-files-found: ignore

  # Cross-platform compilation check - disabled for now to focus on tests
  # Uncomment when needed to verify cross-platform compatibility
  
  # cross-platform-check:
  #   name: Check Test Compilation - ${{ matrix.os }}
  #   strategy:
  #     matrix:
  #       os: [windows-latest, macos-latest]
  #   
  #   runs-on: ${{ matrix.os }}
  #   
  #   steps:
  #   - name: Checkout code
  #     uses: actions/checkout@v4
  #
  #   - name: Install Rust toolchain
  #     uses: dtolnay/rust-toolchain@stable
  #
  #   - name: Cache cargo registry
  #     uses: actions/cache@v4
  #     with:
  #       path: ~/.cargo/registry
  #       key: ${{ runner.os }}-cargo-registry-cucumber-${{ hashFiles('**/Cargo.lock') }}
  #       restore-keys: |
  #         ${{ runner.os }}-cargo-registry-cucumber-
  #         ${{ runner.os }}-cargo-registry-
  #
  #   - name: Check test compilation
  #     run: |
  #       echo "Checking that tests compile on ${{ matrix.os }}..."
  #       cargo test --test integration_tests --no-run --verbose
  #     continue-on-error: true
  #
  #   - name: Report compilation status
  #     run: |
  #       if [ $? -eq 0 ]; then
  #         echo "✅ Tests compile successfully on ${{ matrix.os }}"
  #       else
  #         echo "::warning::Tests don't compile on ${{ matrix.os }} - this may need platform-specific fixes"
  #       fi
  #     shell: bash